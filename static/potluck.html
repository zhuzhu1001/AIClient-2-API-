<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API å¤§é”…é¥­ - Key ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #333; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 24px; color: #fff; display: flex; align-items: center; gap: 10px; }
        h1 span { font-size: 28px; }
        .stats-bar { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px 25px; min-width: 150px; }
        .stat-card .label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #4ade80; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn-primary { background: #4ade80; color: #000; font-weight: 600; }
        .btn-primary:hover { background: #22c55e; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .keys-section { margin-top: 30px; }
        .keys-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .keys-header h2 { font-size: 18px; color: #fff; }
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-box { padding: 8px 12px; border: 1px solid #333; border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; width: 200px; }
        .search-box:focus { outline: none; border-color: #4ade80; }
        .sort-select { padding: 8px 12px; border: 1px solid #333; border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; cursor: pointer; }
        .sort-select:focus { outline: none; border-color: #4ade80; }
        .keys-list { display: flex; flex-direction: column; gap: 12px; }
        .key-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .key-card.disabled { opacity: 0.5; }
        .key-info { flex: 1; min-width: 200px; }
        .key-name { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 5px; }
        .key-id { font-family: monospace; font-size: 13px; color: #888; display: flex; align-items: center; gap: 8px; }
        .btn-copy { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
        .btn-copy:hover { background: rgba(255,255,255,0.1); }
        .key-stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .key-stat { text-align: center; min-width: 80px; }
        .key-stat .label { font-size: 11px; color: #666; }
        .key-stat .value { font-size: 14px; font-weight: 600; }
        .key-stat .value.warning { color: #fbbf24; }
        .key-stat .value.danger { color: #ef4444; }
        .key-stat .value.muted { color: #666; font-size: 12px; }
        .key-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .progress-bar { width: 80px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar .fill { height: 100%; background: #4ade80; transition: width 0.3s; }
        .progress-bar .fill.warning { background: #fbbf24; }
        .progress-bar .fill.danger { background: #ef4444; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #fff; font-size: 18px; }
        .modal-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #888; font-size: 13px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #4ade80; }
        .key-display { background: #0f172a; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; color: #4ade80; word-break: break-all; margin: 15px 0; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state p { margin-bottom: 20px; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #1e293b; border-radius: 8px; color: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid #4ade80; }
        .toast.error { border-left: 4px solid #ef4444; }
        .no-results { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>ğŸ²</span> API å¤§é”…é¥­</h1>
            <button id="createKeyBtn" class="btn btn-primary">+ ç”Ÿæˆæ–° Key</button>
        </header>
        <div class="stats-bar">
            <div class="stat-card"><div class="label">æ€» Key æ•°</div><div class="value" id="totalKeys">0</div></div>
            <div class="stat-card"><div class="label">å·²å¯ç”¨</div><div class="value" id="enabledKeys">0</div></div>
            <div class="stat-card"><div class="label">ä»Šæ—¥æ€»è°ƒç”¨</div><div class="value" id="todayUsage">0</div></div>
            <div class="stat-card"><div class="label">ç´¯è®¡è°ƒç”¨</div><div class="value" id="totalUsage">0</div></div>
        </div>
        <div class="keys-section">
            <div class="keys-header">
                <h2>Key åˆ—è¡¨</h2>
                <div class="toolbar">
                    <input type="text" id="searchBox" class="search-box" placeholder="æœç´¢åç§°æˆ– Key...">
                    <select id="sortSelect" class="sort-select">
                        <option value="name-asc">åç§° A-Z</option>
                        <option value="name-desc">åç§° Z-A</option>
                        <option value="usage-desc">ä»Šæ—¥ç”¨é‡ â†“</option>
                        <option value="usage-asc">ä»Šæ—¥ç”¨é‡ â†‘</option>
                        <option value="total-desc">ç´¯è®¡ç”¨é‡ â†“</option>
                        <option value="lastUsed-desc">æœ€è¿‘ä½¿ç”¨ â†“</option>
                        <option value="created-desc">åˆ›å»ºæ—¶é—´ â†“</option>
                    </select>
                </div>
            </div>
            <div id="keysList" class="keys-list"></div>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ç”Ÿæˆæ–° API Key</h3><button class="modal-close" onclick="closeModal('createModal')">&times;</button></div>
            <div class="form-group"><label>Key åç§° (å¯é€‰)</label><input type="text" id="keyName" placeholder="ä¾‹å¦‚ï¼šæµ‹è¯•ç”¨æˆ·1"></div>
            <div class="form-group"><label>æ¯æ—¥è°ƒç”¨é™é¢</label><input type="number" id="keyLimit" value="1000" min="1"></div>
            <button class="btn btn-primary" style="width:100%" onclick="createKey()">ç”Ÿæˆ Key</button>
        </div>
    </div>
    <div id="showKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ‰ Key å·²ç”Ÿæˆ</h3><button class="modal-close" onclick="closeModal('showKeyModal')">&times;</button></div>
            <p style="color:#888;margin-bottom:10px">è¯·å¦¥å–„ä¿å­˜æ­¤ Keyï¼Œå…³é—­åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼š</p>
            <div class="key-display" id="newKeyDisplay"></div>
            <button class="btn btn-secondary" style="width:100%" onclick="copyKey()">ğŸ“‹ å¤åˆ¶ Key</button>
        </div>
    </div>
    <div id="editLimitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ä¿®æ”¹æ¯æ—¥é™é¢</h3><button class="modal-close" onclick="closeModal('editLimitModal')">&times;</button></div>
            <div class="form-group"><label>æ–°çš„æ¯æ—¥é™é¢</label><input type="number" id="newLimit" min="1"></div>
            <input type="hidden" id="editKeyId">
            <button class="btn btn-primary" style="width:100%" onclick="updateLimit()">ä¿å­˜</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        let currentNewKey = '';
        let allKeys = [];
        const API_BASE = '/api/potluck';
        function getToken() { return localStorage.getItem('authToken'); }
        async function apiRequest(url, options = {}) {
            const token = getToken();
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch(url, { ...options, headers });
            const data = await response.json();
            if (response.status === 401) { window.location.href = '/login.html'; return null; }
            return data;
        }
        async function loadData() {
            const result = await apiRequest(`${API_BASE}/keys`);
            if (!result || !result.success) { showToast('åŠ è½½å¤±è´¥', 'error'); return; }
            const { keys, stats } = result.data;
            document.getElementById('totalKeys').textContent = stats.totalKeys;
            document.getElementById('enabledKeys').textContent = stats.enabledKeys;
            document.getElementById('todayUsage').textContent = stats.todayTotalUsage;
            document.getElementById('totalUsage').textContent = stats.totalUsage;
            allKeys = keys;
            applyFilterAndSort();
        }
        function applyFilterAndSort() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const sortValue = document.getElementById('sortSelect').value;
            let filtered = allKeys;
            if (searchTerm) {
                filtered = allKeys.filter(k => k.name.toLowerCase().includes(searchTerm) || k.id.toLowerCase().includes(searchTerm));
            }
            const [field, order] = sortValue.split('-');
            filtered.sort((a, b) => {
                let va, vb;
                if (field === 'name') { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }
                else if (field === 'usage') { va = a.todayUsage; vb = b.todayUsage; }
                else if (field === 'total') { va = a.totalUsage; vb = b.totalUsage; }
                else if (field === 'lastUsed') { va = a.lastUsedAt || ''; vb = b.lastUsedAt || ''; }
                else if (field === 'created') { va = a.createdAt || ''; vb = b.createdAt || ''; }
                if (va < vb) return order === 'asc' ? -1 : 1;
                if (va > vb) return order === 'asc' ? 1 : -1;
                return 0;
            });
            renderKeys(filtered);
        }
        function formatTime(isoStr) {
            if (!isoStr) return 'ä»æœª';
            const d = new Date(isoStr);
            const now = new Date();
            const diff = now - d;
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            return d.toLocaleDateString();
        }
        function renderKeys(keys) {
            const container = document.getElementById('keysList');
            if (allKeys.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰ä»»ä½• API Key</p><button class="btn btn-primary" onclick="openModal(\'createModal\')">ç”Ÿæˆç¬¬ä¸€ä¸ª Key</button></div>';
                return;
            }
            if (keys.length === 0) {
                container.innerHTML = '<div class="no-results">æ²¡æœ‰åŒ¹é…çš„ç»“æœ</div>';
                return;
            }
            container.innerHTML = keys.map(key => {
                const usagePercent = key.dailyLimit > 0 ? (key.todayUsage / key.dailyLimit * 100) : 0;
                const progressClass = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : '';
                const valueClass = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : '';
                return `<div class="key-card ${key.enabled ? '' : 'disabled'}">
                    <div class="key-info"><div class="key-name">${escapeHtml(key.name)}</div><div class="key-id">${key.maskedKey} <button class="btn-copy" onclick="copyToClipboard('${key.id}')" title="å¤åˆ¶å®Œæ•´ Key">ğŸ“‹</button></div></div>
                    <div class="key-stats">
                        <div class="key-stat"><div class="label">ä»Šæ—¥/é™é¢</div><div class="value ${valueClass}">${key.todayUsage}/${key.dailyLimit}</div><div class="progress-bar"><div class="fill ${progressClass}" style="width:${Math.min(usagePercent, 100)}%"></div></div></div>
                        <div class="key-stat"><div class="label">ç´¯è®¡</div><div class="value">${key.totalUsage}</div></div>
                        <div class="key-stat"><div class="label">æœ€åè°ƒç”¨</div><div class="value muted">${formatTime(key.lastUsedAt)}</div></div>
                        <div class="key-stat"><div class="label">çŠ¶æ€</div><div class="value" style="color:${key.enabled ? '#4ade80' : '#ef4444'}">${key.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</div></div>
                    </div>
                    <div class="key-actions">
                        <button class="btn btn-secondary btn-sm" onclick="resetUsage('${key.id}')">é‡ç½®</button>
                        <button class="btn btn-secondary btn-sm" onclick="openEditLimit('${key.id}', ${key.dailyLimit})">é™é¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleKey('${key.id}')">${key.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteKey('${key.id}')">åˆ é™¤</button>
                    </div>
                </div>`;
            }).join('');
        }
        async function createKey() {
            const name = document.getElementById('keyName').value;
            const dailyLimit = parseInt(document.getElementById('keyLimit').value) || 1000;
            const result = await apiRequest(`${API_BASE}/keys`, { method: 'POST', body: JSON.stringify({ name, dailyLimit }) });
            if (result && result.success) {
                currentNewKey = result.data.id;
                document.getElementById('newKeyDisplay').textContent = currentNewKey;
                closeModal('createModal'); openModal('showKeyModal'); loadData();
                document.getElementById('keyName').value = ''; document.getElementById('keyLimit').value = '1000';
            } else { showToast(result?.error?.message || 'åˆ›å»ºå¤±è´¥', 'error'); }
        }
        function copyKey() { navigator.clipboard.writeText(currentNewKey).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('Key å·²å¤åˆ¶', 'success')); }
        async function resetUsage(keyId) {
            if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥ Key çš„ä»Šæ—¥è°ƒç”¨æ¬¡æ•°å—ï¼Ÿ')) return;
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/reset`, { method: 'POST' });
            if (result && result.success) { showToast('å·²é‡ç½®', 'success'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }
        function openEditLimit(keyId, currentLimit) {
            document.getElementById('editKeyId').value = keyId;
            document.getElementById('newLimit').value = currentLimit;
            openModal('editLimitModal');
        }
        async function updateLimit() {
            const keyId = document.getElementById('editKeyId').value;
            const dailyLimit = parseInt(document.getElementById('newLimit').value);
            if (!dailyLimit || dailyLimit < 1) { showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é™é¢', 'error'); return; }
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/limit`, { method: 'PUT', body: JSON.stringify({ dailyLimit }) });
            if (result && result.success) { showToast('é™é¢å·²æ›´æ–°', 'success'); closeModal('editLimitModal'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }
        async function toggleKey(keyId) {
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/toggle`, { method: 'POST' });
            if (result && result.success) { showToast(result.message, 'success'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }
        async function deleteKey(keyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ Key å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}`, { method: 'DELETE' });
            if (result && result.success) { showToast('å·²åˆ é™¤', 'success'); loadData(); }
            else { showToast(result?.error?.message || 'åˆ é™¤å¤±è´¥', 'error'); }
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message; toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; }
        document.getElementById('createKeyBtn').addEventListener('click', () => openModal('createModal'));
        document.getElementById('searchBox').addEventListener('input', applyFilterAndSort);
        document.getElementById('sortSelect').addEventListener('change', applyFilterAndSort);
        if (!getToken()) { window.location.href = '/login.html'; } else { loadData(); }
    </script>
</body>
</html>